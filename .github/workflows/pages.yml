name: pages

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  release:
    types: [published]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update dynamic content
        id: update
        run: |
          echo "üîÑ Updating dynamic content..."

          # 1. Êõ¥Êñ∞ GitHub ‰ªìÂ∫ìÁªüËÆ°
          echo "üìä Fetching repository stats..."
          STATS=$(curl -s "https://api.github.com/repos/${{ github.repository }}" || echo "3.4.2")
          if [ -n "$STATS" ]; then
            STARS=$(echo "$STATS" | sed -n 's/.*"stargazers_count": *\([0-9]*\).*/\1/p' | head -1)
            FORKS=$(echo "$STATS" | sed -n 's/.*"forks_count": *\([0-9]*\).*/\1/p' | head -1)
            ISSUES=$(echo "$STATS" | sed -n 's/.*"open_issues_count": *\([0-9]*\).*/\1/p' | head -1)
            STARS=${STARS:-0}
            FORKS=${FORKS:-0}
            ISSUES=${ISSUES:-0}
            echo "{\"stars\":$STARS,\"forks\":$FORKS,\"issues\":$ISSUES,\"lastUpdated\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > docs/stats.json
            echo "‚úÖ Stats updated: Stars=$STARS, Forks=$FORKS, Issues=$ISSUES"
          else
            echo "‚ö†Ô∏è Failed to fetch stats, using defaults"
            echo '{"stars":0,"forks":0,"issues":0,"lastUpdated":"'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}' > docs/stats.json
          fi

          # 2. Êõ¥Êñ∞ Release ‰ø°ÊÅØ
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            RELEASE_NAME="${{ github.event.release.name }}"
            RELEASE_BODY=$(echo '${{ github.event.release.body }}' | sed 's/"/\\"/g' | tr -d '\n')
            echo "{\"version\":\"$VERSION\",\"name\":\"$RELEASE_NAME\",\"publishedAt\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"body\":\"$RELEASE_BODY\"}" > docs/release.json
            echo "‚úÖ Release info updated: $VERSION"
          fi

          # 3. ÂêåÊ≠• POM ÁâàÊú¨Âà∞ docs/data.json
          POM_VERSION=$(sed -n 's/.*<revision>\(.*\)<\/revision>.*/\1/p' pom.xml 2>/dev/null || echo "3.4.2")
          if [ -f "docs/data.json" ]; then
            sed -i.bak "s/\"version\": *\"[^\"]*\"/\"version\": \"$POM_VERSION\"/" docs/data.json
            echo "‚úÖ Updated docs/data.json version to $POM_VERSION"
            rm -f docs/data.json.bak
          else
            echo "‚ùå docs/data.json not found"
            exit 1
          fi

      - name: Validate docs structure
        run: |
          echo "üîç Validating docs structure..."
          for file in index.html data.json; do
            if [ ! -f "docs/$file" ]; then
              echo "‚ùå docs/$file not found"
              exit 1
            fi
            echo "‚úÖ Found docs/$file"
          done

          if grep -q '"version":' docs/data.json && grep -q '"lastUpdate":' docs/data.json; then
            echo "‚úÖ data.json structure valid"
          else
            echo "‚ùå data.json structure invalid"
            exit 1
          fi

          POM_VERSION=$(sed -n 's/.*<revision>\(.*\)<\/revision>.*/\1/p' pom.xml 2>/dev/null || echo "3.4.2")
          DOCS_VERSION=$(sed -n 's/.*"version": *"\([^"]*\)".*/\1/p' docs/data.json)
          if [ "$POM_VERSION" = "$DOCS_VERSION" ]; then
            echo "‚úÖ Version consistent: $POM_VERSION"
          else
            echo "‚ùå Version mismatch: POM=$POM_VERSION, Docs=$DOCS_VERSION"
            exit 1
          fi
          echo "‚úÖ All validations passed"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          destination_dir: .
          keep_files: false
          force_orphan: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: |
            üìö GitHub Pages Update
            Event: ${{ github.event_name }}
            Actor: ${{ github.actor }}
            ${{ github.event_name == 'release' && format('Release: {0}', github.event.release.tag_name) || '' }}
            ü§ñ Auto-deployed by GitHub Actions

      - name: Deployment Summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            STATUS="Success"
            SITE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          else
            STATUS="Failed"
            SITE_URL="N/A"
          fi

          echo "## GitHub Pages Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Status: $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- Event: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Actor: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- Time: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Access:" >> $GITHUB_STEP_SUMMARY
          echo "- Live Site: $SITE_URL" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event_name }}" = "release" ]; then
            echo "- Release: ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          fi
