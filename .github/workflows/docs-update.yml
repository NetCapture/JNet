name: ðŸ“š GitHub Pages Auto Update

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # æŽ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨æ›´æ–°
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'README.md'
      - 'update.md'

  # å‘å¸ƒ release æ—¶æ›´æ–°
  release:
    types: [published, edited]

# è®¾ç½®æƒé™
permissions:
  contents: write
  pages: write
  id-token: write

# å–æ¶ˆå¹¶å‘è¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # æž„å»ºå’Œæ›´æ–°æ–‡æ¡£
  update-docs:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Check for Documentation Changes
        id: changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "^docs/"; then
            echo "docs_changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Documentation changes detected"
          else
            echo "docs_changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No documentation changes"
          fi

      - name: ðŸ“Š Update GitHub Stats
        if: steps.changes.outputs.docs_changed == 'true'
        run: |
          echo "ðŸ”„ Updating GitHub stats in documentation..."

          # èŽ·å–ä»“åº“ç»Ÿè®¡ä¿¡æ¯
          STATS=$(curl -s "https://api.github.com/repos/${{ github.repository }}")
          STARS=$(echo "$STATS" | jq -r '.stargazers_count')
          FORKS=$(echo "$STATS" | jq -r '.forks_count')
          ISSUES=$(echo "$STATS" | jq -r '.open_issues_count')

          echo "Stars: $STARS, Forks: $FORKS, Issues: $ISSUES"

          # æ›´æ–° README.md ä¸­çš„ç»Ÿè®¡ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          if [ -f "README.md" ]; then
            sed -i "s/![Stars].*/![Stars](https://img.shields.io/badge/stars-$STARS-blue)/" README.md || true
            sed -i "s/![Forks].*/![Forks](https://img.shields.io/badge/forks-$FORKS-green)/" README.md || true
          fi

      - name: ðŸŽ¨ Generate Changelog Summary
        if: steps.changes.outputs.docs_changed == 'true'
        run: |
          echo "ðŸ“ Generating changelog summary..."

          # èŽ·å–æœ€æ–° release ä¿¡æ¯
          RELEASE=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/latest")
          VERSION=$(echo "$RELEASE" | jq -r '.tag_name')
          BODY=$(echo "$RELEASE" | jq -r '.body')
          PUBLISHED=$(echo "$RELEASE" | jq -r '.published_at')

          echo "Latest Version: $VERSION"
          echo "Published: $PUBLISHED"

          # åˆ›å»ºæ›´æ–°æ—¥å¿—æ‘˜è¦
          cat > /tmp/release_summary.md << EOF
          ## ðŸš€ Latest Release: $VERSION

          **Published:** $PUBLISHED

          ### Summary
          $BODY

          ---

          *Auto-generated by GitHub Actions*
          EOF

      - name: ðŸ“¦ Update Documentation Metadata
        if: steps.changes.outputs.docs_changed == 'true'
        run: |
          # æ›´æ–° docs ç›®å½•ä¸‹çš„å…ƒæ•°æ®æ–‡ä»¶
          if [ -f "docs/last-update.txt" ]; then
            echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC")" > docs/last-update.txt
          fi

          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          cat > docs/version-info.json << EOF
          {
            "version": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "actor": "${{ github.actor }}",
            "event": "${{ github.event_name }}"
          }
          EOF

      - name: ðŸš€ Deploy to GitHub Pages
        if: steps.changes.outputs.docs_changed == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          destination_dir: .
          keep_files: false
          force_orphan: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ðŸ“š Update GitHub Pages: ${{ github.event.head_commit.message }}'

  # Release å‘å¸ƒæ—¶çš„ç‰¹æ®Šå¤„ç†
  release-update:
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŽ‰ Update Release Info in Docs
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          RELEASE_NAME="${{ github.event.release.name }}"
          RELEASE_BODY="${{ github.event.release.body }}"
          RELEASE_URL="${{ github.event.release.html_url }}"

          echo "ðŸ“¦ Processing release: $RELEASE_TAG"

          # åˆ›å»º release é€šçŸ¥æ–‡ä»¶
          cat > docs/release-notice.md << EOF
          # ðŸš€ New Release Available!

          **Version:** $RELEASE_TAG
          **Name:** $RELEASE_NAME
          **URL:** $RELEASE_URL

          ## What's New
          $RELEASE_BODY

          ---

          *Published: ${{ github.event.release.published_at }}*
          EOF

          # æ›´æ–° showcase é¡µé¢çš„ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¦‚æžœéœ€è¦ï¼‰
          if [ -f "docs/showcase.html" ]; then
            echo "Updating showcase version info..."
            # è¿™é‡Œå¯ä»¥æ·»åŠ ç‰ˆæœ¬æ›´æ–°é€»è¾‘
          fi

      - name: ðŸš€ Deploy Release Update
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          destination_dir: .
          keep_files: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ðŸŽ‰ Release ${{ github.event.release.tag_name }} - Update Documentation'

  # è‡ªåŠ¨åŒ–æµ‹è¯•
  test-docs:
    runs-on: ubuntu-latest
    needs: [update-docs]
    if: always() && (needs.update-docs.result == 'success' || needs.update-docs.result == 'skipped')

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ§ª Validate HTML
        run: |
          echo "ðŸ” Validating HTML files..."

          # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          for file in index.html showcase.html discuss.html profile.html; do
            if [ -f "docs/$file" ]; then
              echo "âœ… docs/$file exists"
              # ç®€å•çš„ HTML éªŒè¯
              if grep -q "<!DOCTYPE html>" "docs/$file"; then
                echo "âœ… docs/$file has valid DOCTYPE"
              else
                echo "âŒ docs/$file missing DOCTYPE"
                exit 1
              fi
            else
              echo "âš ï¸ docs/$file not found"
            fi
          done

      - name: ðŸ§ª Validate JavaScript
        run: |
          echo "ðŸ” Validating JavaScript files..."

          for file in i18n.js app.js search.js; do
            if [ -f "docs/$file" ]; then
              echo "âœ… docs/$file exists"
              # æ£€æŸ¥è¯­æ³•é”™è¯¯ï¼ˆåŸºæœ¬æ£€æŸ¥ï¼‰
              if node -c "docs/$file" 2>/dev/null; then
                echo "âœ… docs/$file syntax valid"
              else
                echo "âš ï¸ docs/$file may have syntax issues (skipping)"
              fi
            else
              echo "âš ï¸ docs/$file not found"
            fi
          done

      - name: ðŸ“‹ Create Test Summary
        run: |
          echo "## ðŸ“‹ Documentation Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Updated" >> $GITHUB_STEP_SUMMARY
          git diff --name-only HEAD~1 HEAD 2>/dev/null | grep "^docs/" >> $GITHUB_STEP_SUMMARY || echo "No changes detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All validations passed" >> $GITHUB_STEP_SUMMARY

  # é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
  notify:
    runs-on: ubuntu-latest
    needs: [update-docs, test-docs]
    if: always() && (needs.update-docs.result == 'success' || needs.test-docs.result == 'success')

    steps:
      - name: ðŸ“¨ Create Notification
        run: |
          echo "## ðŸ“š GitHub Pages Updated" > /tmp/notification.md
          echo "" >> /tmp/notification.md
          echo "âœ… Documentation has been successfully updated!" >> /tmp/notification.md
          echo "" >> /tmp/notification.md
          echo "**Repository:** ${{ github.repository }}" >> /tmp/notification.md
          echo "**Event:** ${{ github.event_name }}" >> /tmp/notification.md
          echo "**Actor:** ${{ github.actor }}" >> /tmp/notification.md
          echo "" >> /tmp/notification.md
          echo "ðŸ”— [View Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> /tmp/notification.md

          cat /tmp/notification.md