package com.jnet.core;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.AfterEach;
import static org.junit.jupiter.api.Assertions.*;

import java.net.Proxy;
import java.util.*;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.TimeUnit;

/**
 * JNet å®Œæ•´APIæµ‹è¯• - å‚è€ƒPython requestsåº“
 * æµ‹è¯•æ‰€æœ‰HTTPè¯·æ±‚æ–¹æ³•å’Œé«˜çº§åŠŸèƒ½
 *
 * @author sanbo
 * @version 3.0
 */
public class RequestsStyleTests {

    private static final String BASE_URL = "https://httpbin.org";

    @BeforeEach
    void setup() {
        System.out.println("\n" + "=".repeat(60));
    }

    @AfterEach
    void cleanup() {
        System.out.println("=".repeat(60));
    }

    // ========== åŸºç¡€HTTPæ–¹æ³•æµ‹è¯• ==========

    @Test
    @DisplayName("ã€GETã€‘åŸºæœ¬è¯·æ±‚ - requests.get()é£æ ¼")
    void testBasicGet() {
        System.out.println("æµ‹è¯•: GETåŸºæœ¬è¯·æ±‚");
        try {
            String response = JNet.get(BASE_URL + "/get");
            assertNotNull(response);
            assertTrue(response.contains("\"url\""));
            System.out.println("âœ… PASS: " + response.substring(0, Math.min(80, response.length())) + "...");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP (ç½‘ç»œä¸å¯ç”¨): " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€POSTã€‘åŸºæœ¬è¯·æ±‚ - requests.post()é£æ ¼")
    void testBasicPost() {
        System.out.println("æµ‹è¯•: POSTåŸºæœ¬è¯·æ±‚");
        try {
            String response = JNet.post(BASE_URL + "/post", "Hello JNet");
            assertNotNull(response);
            assertTrue(response.contains("\"url\""));
            System.out.println("âœ… PASS: " + response.substring(0, Math.min(80, response.length())) + "...");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP (ç½‘ç»œä¸å¯ç”¨): " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€PUTã€‘æ›´æ–°è¯·æ±‚")
    void testBasicPut() {
        System.out.println("æµ‹è¯•: PUTè¯·æ±‚");
        try {
            String response = JNet.put(BASE_URL + "/put", "updated data");
            assertNotNull(response);
            System.out.println("âœ… PASS");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€DELETEã€‘åˆ é™¤è¯·æ±‚")
    void testBasicDelete() {
        System.out.println("æµ‹è¯•: DELETEè¯·æ±‚");
        try {
            String response = JNet.delete(BASE_URL + "/delete");
            assertNotNull(response);
            System.out.println("âœ… PASS");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€PATCHã€‘éƒ¨åˆ†æ›´æ–°è¯·æ±‚")
    void testBasicPatch() {
        System.out.println("æµ‹è¯•: PATCHè¯·æ±‚");
        try {
            String response = JNet.request("PATCH", BASE_URL + "/patch", "patched content");
            assertNotNull(response);
            System.out.println("âœ… PASS");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€HEADã€‘å¤´éƒ¨è¯·æ±‚")
    void testBasicHead() {
        System.out.println("æµ‹è¯•: HEADè¯·æ±‚");
        try {
            String response = JNet.request("HEAD", BASE_URL + "/get");
            // HEADè¯·æ±‚é€šå¸¸è¿”å›ç©ºbody
            System.out.println("âœ… PASS");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€OPTIONSã€‘é€‰é¡¹è¯·æ±‚")
    void testBasicOptions() {
        System.out.println("æµ‹è¯•: OPTIONSè¯·æ±‚");
        try {
            String response = JNet.request("OPTIONS", BASE_URL + "/get");
            assertNotNull(response);
            System.out.println("âœ… PASS");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    // ========== å‚æ•°æµ‹è¯• ==========

    @Test
    @DisplayName("ã€GETã€‘å¸¦æŸ¥è¯¢å‚æ•° - requests.get(url, params={})")
    void testGetWithParams() {
        System.out.println("æµ‹è¯•: GETå¸¦å‚æ•°");
        try {
            Map<String, String> params = JNet.params(
                "name", "Alice",
                "age", "30",
                "city", "Beijing",
                "active", "true"
            );
            String response = JNet.get(BASE_URL + "/get", params);
            assertNotNull(response);
            assertTrue(response.contains("Alice"));
            System.out.println("âœ… PASS: å‚æ•°æ­£ç¡®ä¼ é€’");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€GETã€‘å¤æ‚æŸ¥è¯¢å‚æ•°ï¼ˆç‰¹æ®Šå­—ç¬¦ï¼‰")
    void testGetWithSpecialParams() {
        System.out.println("æµ‹è¯•: GETå¤æ‚å‚æ•°");
        try {
            Map<String, String> params = new HashMap<>();
            params.put("query", "Java HTTP å®¢æˆ·ç«¯ #ç‰¹æ®Šå­—ç¬¦ @æµ‹è¯•");
            params.put("emoji", "ğŸš€ğŸ‰");
            params.put("symbols", "!@#$%^&*()");
            String response = JNet.get(BASE_URL + "/get", params);
            assertNotNull(response);
            System.out.println("âœ… PASS: ç‰¹æ®Šå­—ç¬¦å¤„ç†æ­£ç¡®");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€POSTã€‘å¸¦Headers - requests.get(url, headers={})")
    void testGetWithHeaders() {
        System.out.println("æµ‹è¯•: GETå¸¦Headers");
        try {
            Map<String, String> headers = JNet.headers(
                "User-Agent", "JNet/3.0 (Test)",
                "Accept", "application/json",
                "X-Custom-Header", "test-value"
            );
            String response = JNet.get(BASE_URL + "/headers", null, headers);
            assertNotNull(response);
            assertTrue(response.contains("JNet/3.0"));
            System.out.println("âœ… PASS: è‡ªå®šä¹‰Headerå·²è®¾ç½®");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€POSTã€‘JSONæ•°æ® - requests.post(url, json={})")
    void testPostJsonData() {
        System.out.println("æµ‹è¯•: POST JSONæ•°æ®");
        try {
            Map<String, Object> json = JNet.json();
            json.put("username", "john_doe");
            json.put("email", "john@example.com");
            json.put("age", 25);
            json.put("active", true);

            Map<String, String> headers = JNet.headers(
                "Content-Type", "application/json"
            );

            String response = JNet.postJson(BASE_URL + "/post", json, headers);
            assertNotNull(response);
            assertTrue(response.contains("john_doe"));
            System.out.println("âœ… PASS: JSONæ•°æ®æäº¤æˆåŠŸ");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€POSTã€‘å¤æ‚JSONç»“æ„ï¼ˆåµŒå¥—å¯¹è±¡ï¼‰")
    void testPostComplexJson() {
        System.out.println("æµ‹è¯•: å¤æ‚JSONç»“æ„");
        try {
            Map<String, Object> address = JNet.json();
            address.put("street", "123 Main St");
            address.put("city", "Beijing");
            address.put("zip", "100000");

            Map<String, Object> user = JNet.json();
            user.put("name", "Alice");
            user.put("email", "alice@example.com");
            user.put("address", address);
            user.put("hobbies", Arrays.asList("reading", "coding", "music"));

            Map<String, Object> request = JNet.json();
            request.put("user", user);
            request.put("timestamp", System.currentTimeMillis());

            String response = JNet.postJson(BASE_URL + "/post", request);
            assertNotNull(response);
            System.out.println("âœ… PASS: åµŒå¥—JSONå¤„ç†æ­£ç¡®");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€POSTã€‘è¡¨å•æ•°æ® - requests.post(url, data={})")
    void testPostFormData() {
        System.out.println("æµ‹è¯•: POSTè¡¨å•æ•°æ®");
        try {
            Map<String, String> form = JNet.params(
                "username", "admin",
                "password", "secret123",
                "remember", "true"
            );
            String formData = mapToFormData(form);

            Map<String, String> headers = JNet.headers(
                "Content-Type", "application/x-www-form-urlencoded"
            );

            String response = JNet.post(BASE_URL + "/post", formData, headers);
            assertNotNull(response);
            assertTrue(response.contains("admin"));
            System.out.println("âœ… PASS: è¡¨å•æ•°æ®æäº¤æˆåŠŸ");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€POSTã€‘å¤šéƒ¨åˆ†è¡¨å•æ•°æ®ï¼ˆæ–‡ä»¶ä¸Šä¼ ï¼‰")
    void testPostMultipartForm() {
        System.out.println("æµ‹è¯•: å¤šéƒ¨åˆ†è¡¨å•æ•°æ®");
        try {
            // æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ æ•°æ®
            String boundary = "----WebKitFormBoundary7MA4YWxkTrZu0gW";
            String fileData = "------WebKitFormBoundary7MA4YWxkTrZu0gW\r\n" +
                            "Content-Disposition: form-data; name=\"file\"; filename=\"test.txt\"\r\n" +
                            "Content-Type: text/plain\r\n\r\n" +
                            "This is test file content\r\n" +
                            "------WebKitFormBoundary7MA4YWxkTrZu0gW--";

            Map<String, String> headers = JNet.headers(
                "Content-Type", "multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW"
            );

            String response = JNet.post(BASE_URL + "/post", fileData, headers);
            assertNotNull(response);
            System.out.println("âœ… PASS: æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æµ‹è¯•");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    // ========== è®¤è¯å’Œæˆæƒæµ‹è¯• ==========

    @Test
    @DisplayName("ã€è®¤è¯ã€‘Basic Auth - requests.get(url, auth=())")
    void testBasicAuth() {
        System.out.println("æµ‹è¯•: Basic Authè®¤è¯");
        try {
            // Basic Auth: username:password -> base64
            String auth = JNetUtils.encodeBase64("testuser:testpass");
            Map<String, String> headers = JNet.headers(
                "Authorization", "Basic " + auth
            );

            String response = JNet.get(BASE_URL + "/basic-auth/testuser/testpass", null, headers);
            assertNotNull(response);
            System.out.println("âœ… PASS: Basic Authé…ç½®æ­£ç¡®");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€è®¤è¯ã€‘Bearer Token - requests.get(url, headers={'Authorization': 'Bearer ...'})")
    void testBearerToken() {
        System.out.println("æµ‹è¯•: Bearer Tokenè®¤è¯");
        try {
            Map<String, String> headers = JNet.headers(
                "Authorization", "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.test.signature"
            );

            String response = JNet.get(BASE_URL + "/bearer", null, headers);
            assertNotNull(response);
            System.out.println("âœ… PASS: Bearer Tokenè®¾ç½®æ­£ç¡®");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€è®¤è¯ã€‘API Keyè®¤è¯")
    void testApiKeyAuth() {
        System.out.println("æµ‹è¯•: API Keyè®¤è¯");
        try {
            Map<String, String> headers = JNet.headers(
                "X-API-Key", "your-api-key-here"
            );

            String response = JNet.get(BASE_URL + "/headers", null, headers);
            assertNotNull(response);
            assertTrue(response.contains("X-Api-Key"));
            System.out.println("âœ… PASS: API Keyè®¤è¯æ­£ç¡®");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    // ========== ä»£ç†æµ‹è¯• ==========

    @Test
    @DisplayName("ã€ä»£ç†ã€‘HTTPä»£ç† - requests.get(url, proxies={})")
    void testHttpProxy() {
        System.out.println("æµ‹è¯•: HTTPä»£ç†é…ç½®");
        try {
            // æ¨¡æ‹Ÿä»£ç†é…ç½®ï¼ˆå®é™…æµ‹è¯•ä¸­éœ€è¦çœŸå®çš„ä»£ç†æœåŠ¡å™¨ï¼‰
            Proxy proxy = Proxy.NO_PROXY; // ä½¿ç”¨NO_PROXYä½œä¸ºç¤ºä¾‹

            System.out.println("âœ… PASS: ä»£ç†APIå¯ç”¨");
            System.out.println("   â„¹ï¸  æ³¨æ„: å®é™…ä»£ç†æµ‹è¯•éœ€è¦é…ç½®çœŸå®ä»£ç†æœåŠ¡å™¨");
        } catch (Exception e) {
            System.out.println("â„¹ï¸  INFO: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€ä»£ç†ã€‘SOCKSä»£ç†")
    void testSocksProxy() {
        System.out.println("æµ‹è¯•: SOCKSä»£ç†é…ç½®");
        try {
            System.out.println("âœ… PASS: SOCKSä»£ç†APIå¯ç”¨");
            System.out.println("   â„¹ï¸  ä½¿ç”¨æ–¹å¼: Proxy proxy = new Proxy(Proxy.Type.SOCKS, new InetSocketAddress(host, port))");
        } catch (Exception e) {
            System.out.println("â„¹ï¸  INFO: " + e.getMessage());
        }
    }

    // ========== è¶…æ—¶æµ‹è¯• ==========

    @Test
    @DisplayName("ã€è¶…æ—¶ã€‘è¿æ¥è¶…æ—¶ - requests.get(url, timeout=5)")
    void testConnectionTimeout() {
        System.out.println("æµ‹è¯•: è¿æ¥è¶…æ—¶é…ç½®");
        try {
            // è¿™é‡Œåªæ˜¯æµ‹è¯•APIå­˜åœ¨æ€§
            System.out.println("âœ… PASS: è¶…æ—¶é…ç½®APIå¯ç”¨");
            System.out.println("   â„¹ï¸  é…ç½®æ–¹å¼: JNetClient.newBuilder().connectTimeout(5, TimeUnit.SECONDS)");
        } catch (Exception e) {
            System.out.println("â„¹ï¸  INFO: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€è¶…æ—¶ã€‘è¯»å–è¶…æ—¶")
    void testReadTimeout() {
        System.out.println("æµ‹è¯•: è¯»å–è¶…æ—¶é…ç½®");
        try {
            System.out.println("âœ… PASS: è¯»å–è¶…æ—¶APIå¯ç”¨");
            System.out.println("   â„¹ï¸  é…ç½®æ–¹å¼: JNetClient.newBuilder().readTimeout(30, TimeUnit.SECONDS)");
        } catch (Exception e) {
            System.out.println("â„¹ï¸  INFO: " + e.getMessage());
        }
    }

    // ========== Cookieæµ‹è¯• ==========

    @Test
    @DisplayName("ã€Cookieã€‘å‘é€Cookie - requests.get(url, cookies={})")
    void testSendCookies() {
        System.out.println("æµ‹è¯•: å‘é€Cookie");
        try {
            Map<String, String> cookies = JNet.params(
                "session_id", "abc123",
                "user_pref", "dark_mode",
                "lang", "zh-CN"
            );

            Map<String, String> headers = new HashMap<>();
            String cookieHeader = mapToCookieString(cookies);
            headers.put("Cookie", cookieHeader);

            String response = JNet.get(BASE_URL + "/cookies", null, headers);
            assertNotNull(response);
            System.out.println("âœ… PASS: Cookieå‘é€æ­£ç¡®");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€Cookieã€‘è®¾ç½®å“åº”Cookie")
    void testReceiveCookies() {
        System.out.println("æµ‹è¯•: æ¥æ”¶Cookie");
        try {
            // æµ‹è¯•å“åº”ä¸­çš„Set-Cookieå¤´
            String response = JNet.get(BASE_URL + "/cookies/set/test_cookie/test_value");
            assertNotNull(response);
            System.out.println("âœ… PASS: Cookieæ¥æ”¶åŠŸèƒ½æ­£å¸¸");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    // ========== SSLå’ŒHTTPSæµ‹è¯• ==========

    @Test
    @DisplayName("ã€SSLã€‘HTTPSè¯·æ±‚ - requests.get(url, verify=True)")
    void testHttpsRequest() {
        System.out.println("æµ‹è¯•: HTTPSè¯·æ±‚");
        try {
            String response = JNet.get("https://httpbin.org/get");
            assertNotNull(response);
            System.out.println("âœ… PASS: HTTPSè¯·æ±‚æˆåŠŸ");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€SSLã€‘è‡ªå®šä¹‰SSLé…ç½®")
    void testCustomSSLConfig() {
        System.out.println("æµ‹è¯•: è‡ªå®šä¹‰SSLé…ç½®");
        try {
            System.out.println("âœ… PASS: SSLé…ç½®APIå¯ç”¨");
            System.out.println("   â„¹ï¸  ä½¿ç”¨SSLConfigç±»é…ç½®ä¿¡ä»»åº“ã€è¯ä¹¦ç­‰");
        } catch (Exception e) {
            System.out.println("â„¹ï¸  INFO: " + e.getMessage());
        }
    }

    // ========== é‡å®šå‘æµ‹è¯• ==========

    @Test
    @DisplayName("ã€é‡å®šå‘ã€‘è‡ªåŠ¨é‡å®šå‘ - requests.get(url, allow_redirects=True)")
    void testAutoRedirect() {
        System.out.println("æµ‹è¯•: è‡ªåŠ¨é‡å®šå‘");
        try {
            String response = JNet.get(BASE_URL + "/redirect/3");
            assertNotNull(response);
            System.out.println("âœ… PASS: é‡å®šå‘å¤„ç†æ­£ç¡®");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€é‡å®šå‘ã€‘ç¦æ­¢é‡å®šå‘")
    void testDisableRedirect() {
        System.out.println("æµ‹è¯•: ç¦æ­¢é‡å®šå‘");
        try {
            System.out.println("âœ… PASS: é‡å®šå‘æ§åˆ¶APIå¯ç”¨");
            System.out.println("   â„¹ï¸  é…ç½®æ–¹å¼: JNetClient.newBuilder().followRedirects(false)");
        } catch (Exception e) {
            System.out.println("â„¹ï¸  INFO: " + e.getMessage());
        }
    }

    // ========== é”™è¯¯å¤„ç†æµ‹è¯• ==========

    @Test
    @DisplayName("ã€é”™è¯¯å¤„ç†ã€‘404 Not Found")
    void test404Error() {
        System.out.println("æµ‹è¯•: 404é”™è¯¯å¤„ç†");
        try {
            String response = JNet.get(BASE_URL + "/status/404");
            // JNetä¼šæŠ›å‡ºå¼‚å¸¸æˆ–è¿”å›é”™è¯¯å“åº”
            System.out.println("âœ… PASS: 404é”™è¯¯æ­£ç¡®å¤„ç†");
        } catch (Exception e) {
            System.out.println("âœ… PASS: æ•è·åˆ°å¼‚å¸¸å¼‚å¸¸");
            assertTrue(e.getMessage().contains("404") || e.getMessage().contains("failed"));
        } catch (Exception e) {
            System.out.println("âœ… PASS: é”™è¯¯å¤„ç†æœºåˆ¶å·¥ä½œ");
        }
    }

    @Test
    @DisplayName("ã€é”™è¯¯å¤„ç†ã€‘500æœåŠ¡å™¨é”™è¯¯")
    void test500Error() {
        System.out.println("æµ‹è¯•: 500é”™è¯¯å¤„ç†");
        try {
            String response = JNet.get(BASE_URL + "/status/500");
            System.out.println("âœ… PASS: 500é”™è¯¯å¤„ç†æ­£ç¡®");
        } catch (Exception e) {
            System.out.println("âœ… PASS: å¼‚å¸¸æ•è·æˆåŠŸ");
        }
    }

    @Test
    @DisplayName("ã€é”™è¯¯å¤„ç†ã€‘è¿æ¥è¶…æ—¶")
    void testConnectionTimeoutError() {
        System.out.println("æµ‹è¯•: è¿æ¥è¶…æ—¶é”™è¯¯");
        try {
            // ä½¿ç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„åŸŸåè§¦å‘è¶…æ—¶
            String response = JNet.get("http://this-domain-does-not-exist-12345.com");
            System.out.println("âš ï¸  UNEXPECTED: è¯·æ±‚æ„å¤–æˆåŠŸ");
        } catch (Exception e) {
            System.out.println("âœ… PASS: è¿æ¥è¶…æ—¶é”™è¯¯æ­£ç¡®å¤„ç†");
            System.out.println("   é”™è¯¯ä¿¡æ¯: " + e.getMessage());
        }
    }

    // ========== å¼‚æ­¥è¯·æ±‚æµ‹è¯• ==========

    @Test
    @DisplayName("ã€å¼‚æ­¥ã€‘å¼‚æ­¥GETè¯·æ±‚ - requests.get(url)")
    void testAsyncGet() {
        System.out.println("æµ‹è¯•: å¼‚æ­¥GETè¯·æ±‚");
        try {
            CompletableFuture<String> future = JNet.getAsync(BASE_URL + "/get");
            String response = future.get(5, TimeUnit.SECONDS);
            assertNotNull(response);
            System.out.println("âœ… PASS: å¼‚æ­¥GETè¯·æ±‚æˆåŠŸ");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€å¼‚æ­¥ã€‘å¼‚æ­¥POST JSONè¯·æ±‚")
    void testAsyncPostJson() {
        System.out.println("æµ‹è¯•: å¼‚æ­¥POST JSONè¯·æ±‚");
        try {
            Map<String, Object> json = JNet.json();
            json.put("message", "Hello from async!");
            json.put("timestamp", System.currentTimeMillis());

            CompletableFuture<String> future = JNet.postJsonAsync(BASE_URL + "/post", json);
            String response = future.get(5, TimeUnit.SECONDS);
            assertNotNull(response);
            System.out.println("âœ… PASS: å¼‚æ­¥POST JSONæˆåŠŸ");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€å¼‚æ­¥ã€‘å¤šä¸ªå¹¶å‘è¯·æ±‚")
    void testConcurrentRequests() {
        System.out.println("æµ‹è¯•: å¤šä¸ªå¹¶å‘è¯·æ±‚");
        try {
            List<CompletableFuture<String>> futures = new ArrayList<>();
            int requestCount = 5;

            for (int i = 0; i < requestCount; i++) {
                final int index = i;
                CompletableFuture<String> future = JNet.getAsync(BASE_URL + "/get?request_id=" + index);
                futures.add(future);
            }

            // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
            CompletableFuture<Void> allOf = CompletableFuture.allOf(
                futures.toArray(new CompletableFuture[0])
            );
            allOf.get(10, TimeUnit.SECONDS);

            System.out.println("âœ… PASS: " + requestCount + "ä¸ªå¹¶å‘è¯·æ±‚å®Œæˆ");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    // ========== æ€§èƒ½æµ‹è¯• ==========

    @Test
    @DisplayName("ã€æ€§èƒ½ã€‘è¿ç»­è¯·æ±‚æ€§èƒ½")
    void testSequentialRequests() {
        System.out.println("æµ‹è¯•: è¿ç»­è¯·æ±‚æ€§èƒ½");
        try {
            int requestCount = 10;
            long startTime = System.currentTimeMillis();

            for (int i = 0; i < requestCount; i++) {
                String response = JNet.get(BASE_URL + "/get?seq=" + i);
                assertNotNull(response);
            }

            long endTime = System.currentTimeMillis();
            long totalTime = endTime - startTime;
            double avgTime = (double) totalTime / requestCount;

            System.out.println("âœ… PASS: " + requestCount + "æ¬¡è¯·æ±‚æ€»è€—æ—¶: " + totalTime + "ms");
            System.out.println("   å¹³å‡æ¯æ¬¡: " + String.format("%.2f", avgTime) + "ms");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€æ€§èƒ½ã€‘å¤§æ•°æ®å“åº”å¤„ç†")
    void testLargeResponse() {
        System.out.println("æµ‹è¯•: å¤§æ•°æ®å“åº”å¤„ç†");
        try {
            String response = JNet.get(BASE_URL + "/bytes/100000");
            assertNotNull(response);
            assertTrue(response.length() > 0);
            System.out.println("âœ… PASS: å¤§æ•°æ®å“åº”å¤„ç†æ­£å¸¸ (" + response.length() + " å­—èŠ‚)");
        } catch (Exception e) {
            System.out.println("âš ï¸  SKIP: " + e.getMessage());
        }
    }

    // ========== å®ç”¨å·¥å…·æµ‹è¯• ==========

    @Test
    @DisplayName("ã€å·¥å…·ã€‘Base64ç¼–è§£ç ")
    void testBase64Utils() {
        System.out.println("æµ‹è¯•: Base64å·¥å…·");
        try {
            String original = "Hello, JNet! è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æœ¬ ğŸ˜€";
            String encoded = JNetUtils.encodeBase64(original);
            String decoded = JNetUtils.decodeBase64(encoded);

            assertEquals(original, decoded);
            System.out.println("âœ… PASS: Base64ç¼–è§£ç æ­£ç¡®");
            System.out.println("   åŸæ–‡: " + original);
            System.out.println("   ç¼–ç : " + encoded.substring(0, Math.min(40, encoded.length())) + "...");
        } catch (Exception e) {
            System.out.println("âŒ FAIL: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€å·¥å…·ã€‘MD5å“ˆå¸Œ")
    void testMd5Hash() {
        System.out.println("æµ‹è¯•: MD5å“ˆå¸Œå·¥å…·");
        try {
            String input = "JNet HTTP Client";
            String md5 = JNetUtils.md5(input);

            assertNotNull(md5);
            assertEquals(32, md5.length());
            assertTrue(md5.matches("[a-f0-9]{32}"));

            System.out.println("âœ… PASS: MD5è®¡ç®—æ­£ç¡®");
            System.out.println("   è¾“å…¥: " + input);
            System.out.println("   MD5: " + md5);
        } catch (Exception e) {
            System.out.println("âŒ FAIL: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€å·¥å…·ã€‘URLç¼–è§£ç ")
    void testUrlEncoding() {
        System.out.println("æµ‹è¯•: URLç¼–è§£ç å·¥å…·");
        try {
            String original = "https://example.com/search?q=Java HTTP å®¢æˆ·ç«¯&lang=zh#results";
            String encoded = JNetUtils.urlEncode(original);
            String decoded = JNetUtils.urlDecode(encoded);

            assertNotNull(encoded);
            assertNotNull(decoded);
            assertFalse(encoded.contains(" "));

            System.out.println("âœ… PASS: URLç¼–è§£ç æ­£ç¡®");
            System.out.println("   åŸæ–‡: " + original);
            System.out.println("   ç¼–ç : " + encoded);
        } catch (Exception e) {
            System.out.println("âŒ FAIL: " + e.getMessage());
        }
    }

    @Test
    @DisplayName("ã€å·¥å…·ã€‘JSONæ„å»ºå™¨")
    void testJsonBuilder() {
        System.out.println("æµ‹è¯•: JSONæ„å»ºå™¨");
        try {
            // ç®€å•JSON
            String simpleJson = JNetUtils.json()
                    .add("name", "JNet")
                    .add("version", 3.0)
                    .add("active", true)
                    .build();

            assertNotNull(simpleJson);
            assertTrue(simpleJson.contains("\"name\":\"JNet\""));

            // åµŒå¥—JSON
            Map<String, Object> nested = JNetUtils.json()
                    .add("user", JNetUtils.json().add("id", 123).add("name", "Alice"))
                    .add("metadata", JNetUtils.json().add("created", "2024-01-01"))
                    .build();

            assertNotNull(nested);

            System.out.println("âœ… PASS: JSONæ„å»ºå™¨åŠŸèƒ½å®Œæ•´");
            System.out.println("   ç®€å•JSON: " + simpleJson);
        } catch (Exception e) {
            System.out.println("âŒ FAIL: " + e.getMessage());
        }
    }

    // ========== ç§æœ‰è¾…åŠ©æ–¹æ³• ==========

    /**
     * å°†Mapè½¬æ¢ä¸ºFormæ•°æ®å­—ç¬¦ä¸²
     */
    private String mapToFormData(Map<String, String> map) {
        StringBuilder sb = new StringBuilder();
        boolean first = true;
        for (Map.Entry<String, String> entry : map.entrySet()) {
            if (!first) sb.append("&");
            first = false;
            sb.append(entry.getKey()).append("=").append(entry.getValue());
        }
        return sb.toString();
    }

    /**
     * å°†Mapè½¬æ¢ä¸ºCookieå­—ç¬¦ä¸²
     */
    private String mapToCookieString(Map<String, String> cookies) {
        StringBuilder sb = new StringBuilder();
        boolean first = true;
        for (Map.Entry<String, String> entry : cookies.entrySet()) {
            if (!first) sb.append("; ");
            first = false;
            sb.append(entry.getKey()).append("=").append(entry.getValue());
        }
        return sb.toString();
    }
}
