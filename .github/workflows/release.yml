name: Release Build and Publish

on:
  push:
    tags:
      - 'v*.*.*'

env:
  JAVA_VERSION: '11'
  GITHUB_PACKAGES_REGISTRY: ghcr.io
  PROJECT_NAME: jnt

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          server-id: github
          server-username: GITHUB_USER
          server-password: GITHUB_TOKEN

      - name: Install GPG
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg2

      - name: Import GPG key (if configured)
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --pinentry-mode loopback --passphrase-fd 0 --symmetric --cipher-algo AES256 --armor --output ~/.m2/jnt.gpg ${{ secrets.GPG_PRIVATE_KEY }}
          gpg --batch --import-ownertrust < ~/.m2/jnt.gpg
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                    http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>github-actions[bot]</username>
                <password>\${{ secrets.GITHUB_TOKEN }}</password>
              </server>
              <server>
                <id>ossrh</id>
                <username>\${{ secrets.OSSRH_USERNAME }}</username>
                <password>\${{ secrets.OSSRH_TOKEN }}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>ossrh</id>
                <properties>
                  <gpg.keyname>\${{ secrets.GPG_KEYNAME }}</gpg.keyname>
                  <gpg.executable>gpg</gpg.executable>
                </properties>
              </profile>
            </profiles>
          </settings>
          EOF
        shell: bash

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "Version: $TAG"

      - name: Build with Maven
        run: |
          mvn clean package -DskipTests -Drevision=${{ steps.version.outputs.version }}

      - name: Publish to GitHub Packages
        run: |
          mvn clean deploy -DskipTests -Dgpg.skip=false -X 2>&1 | tee deploy.log || echo "Deploy failed, continuing with artifacts..."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List built artifacts
        run: |
          ls -la target/*.jar 2>/dev/null || echo "No JAR files found in target/"
          ls -la target/*.pom 2>/dev/null || echo "No POM files found in target/"

      - name: Generate Release Notes
        id: release_notes
        run: |
          echo 'release_notes<<EOF' >> $GITHUB_OUTPUT
          echo "## ðŸŽ‰ JNet Release ${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸ“¦ æž„å»ºä¿¡æ¯" >> $GITHUB_OUTPUT
          echo "- ç‰ˆæœ¬: ${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT
          echo "- æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "- Javaç‰ˆæœ¬: ${{ env.JAVA_VERSION }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸ“‹ åŒ…å«å†…å®¹" >> $GITHUB_OUTPUT
          echo "- jnt-${{ steps.version.outputs.version }}.jar" >> $GITHUB_OUTPUT
          echo "- jnt-${{ steps.version.outputs.version }}-sources.jar" >> $GITHUB_OUTPUT
          echo "- jnt-${{ steps.version.outputs.version }}-javadoc.jar" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸ“¥ Mavenä¾èµ–åæ ‡" >> $GITHUB_OUTPUT
          echo "\`\`\`xml" >> $GITHUB_OUTPUT
          echo "<dependency>" >> $GITHUB_OUTPUT
          echo "  <groupId>com.netcapture</groupId>" >> $GITHUB_OUTPUT
          echo "  <artifactId>jnt</artifactId>" >> $GITHUB_OUTPUT
          echo "  <version>${{ steps.version.outputs.version }}</version>" >> $GITHUB_OUTPUT
          echo "</dependency>" >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸš€ ä½¿ç”¨æ–¹æ³•" >> $GITHUB_OUTPUT
          echo "è¯·æŸ¥çœ‹ [GitHub Packages](https://github.com/NetCapture/JNet/packages) èŽ·å–å®Œæ•´çš„ä½¿ç”¨è¯´æ˜Žã€‚" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "---" >> $GITHUB_OUTPUT
          echo "*ç”± GitHub Actions è‡ªåŠ¨æž„å»º*" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.release_notes }}
          draft: false
          prerelease: false
          files: |
            target/jnt-${{ steps.version.outputs.version }}.jar
            target/jnt-${{ steps.version.outputs.version }}-sources.jar
            target/jnt-${{ steps.version.outputs.version }}-javadoc.jar
            target/jnt-${{ steps.version.outputs.version }}.pom
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload JAR to Release Assets
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            target/jnt-${{ steps.version.outputs.version }}.jar
            target/jnt-${{ steps.version.outputs.version }}-sources.jar
            target/jnt-${{ steps.version.outputs.version }}-javadoc.jar
          retention-days: 30

      - name: Summary
        run: |
          echo "### âœ… Release æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "- JARæ–‡ä»¶: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- æºç JAR: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Javadoc JAR: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- å‘å¸ƒåˆ°GitHub Packages: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- åˆ›å»ºGitHub Release: âœ…" >> $GITHUB_STEP_SUMMARY
