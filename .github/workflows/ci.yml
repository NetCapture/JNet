name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  JAVA_VERSION: '11'

jobs:
  # ==================== Job 1: ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥ ====================
  version-check:
    runs-on: ubuntu-latest
    outputs:
      consistent: ${{ steps.check.outputs.consistent }}
      summary: ${{ steps.summary.outputs.report }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Version Consistency
        id: check
        continue-on-error: true
        run: |
          echo "ğŸ” å¼€å§‹ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥..."

          # 1. ä» pom.xml è·å–ç‰ˆæœ¬
          POM_VERSION=$(sed -n 's/.*<revision>\(.*\)<\/revision>.*/\1/p' pom.xml)
          echo "POM ç‰ˆæœ¬: $POM_VERSION"

          # 2. ä» README.md è·å–ç‰ˆæœ¬
          README_VERSION=$(sed -n 's/.*<version>\([^<]*\)<\/version>.*/\1/p' README.md | head -1)
          if [ -z "$README_VERSION" ]; then
            README_VERSION=$(sed -n 's/.*jnt:\([0-9.]*\).*/\1/p' README.md | head -1)
          fi
          echo "README ç‰ˆæœ¬: $README_VERSION"

          # 3. ä» docs/ è·å–ç‰ˆæœ¬
          if [ -f "docs/data.json" ]; then
            DOCS_VERSION=$(sed -n 's/.*"version": *"\([^"]*\)".*/\1/p' docs/data.json | head -1)
          elif [ -f "docs/index.html" ]; then
            DOCS_VERSION=$(sed -n 's/.*v\([0-9.]*\).*/\1/p' docs/index.html | head -1)
          else
            DOCS_VERSION="none"
          fi
          echo "Docs ç‰ˆæœ¬: $DOCS_VERSION"

          # 4. ä» git tag è·å–æœ€æ–°ç‰ˆæœ¬
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          if [ "$LATEST_TAG" != "none" ]; then
            TAG_VERSION=${LATEST_TAG#v}
            echo "Git Tag ç‰ˆæœ¬: $TAG_VERSION"
          else
            TAG_VERSION="none"
            echo "Git Tag ç‰ˆæœ¬: æ— "
          fi

          # 5. æ£€æŸ¥ä¸€è‡´æ€§
          ALL_CONSISTENT=true
          ERRORS=()

          # æ£€æŸ¥ POM vs README
          if [ "$README_VERSION" != "none" ] && [ "$POM_VERSION" != "$README_VERSION" ]; then
            ALL_CONSISTENT=false
            ERRORS+=("POM($POM_VERSION) != README($README_VERSION)")
          fi

          # æ£€æŸ¥ POM vs Docs
          if [ "$DOCS_VERSION" != "none" ] && [ "$POM_VERSION" != "$DOCS_VERSION" ]; then
            ALL_CONSISTENT=false
            ERRORS+=("POM($POM_VERSION) != Docs($DOCS_VERSION)")
          fi

          # æ£€æŸ¥ POM vs Tag
          if [ "$TAG_VERSION" != "none" ] && [ "$POM_VERSION" != "$TAG_VERSION" ]; then
            ALL_CONSISTENT=false
            ERRORS+=("POM($POM_VERSION) != Tag($TAG_VERSION)")
          fi

          # è¾“å‡ºç»“æœ
          if [ "$ALL_CONSISTENT" = true ]; then
            echo "consistent=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰€æœ‰ç‰ˆæœ¬å·ä¸€è‡´: $POM_VERSION"
          else
            echo "consistent=false" >> $GITHUB_OUTPUT
            echo "âŒ ç‰ˆæœ¬ä¸ä¸€è‡´:"
            for error in "${ERRORS[@]}"; do
              echo "  - $error"
            done
          fi

      - name: Generate Version Report
        id: summary
        if: always()
        run: |
          POM_VERSION=$(sed -n 's/.*<revision>\(.*\)<\/revision>.*/\1/p' pom.xml)
          README_VERSION=$(sed -n 's/.*<version>\([^<]*\)<\/version>.*/\1/p' README.md | head -1)
          if [ -z "$README_VERSION" ]; then
            README_VERSION=$(sed -n 's/.*jnt:\([0-9.]*\).*/\1/p' README.md | head -1)
          fi
          DOCS_VERSION=$(sed -n 's/.*"version": *"\([^"]*\)".*/\1/p' docs/data.json 2>/dev/null | head -1 || echo "N/A")
          TAG_VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/v//' || echo "N/A")

          CONSISTENT="${{ steps.check.outputs.consistent }}"

          # Determine status for each source
          README_STATUS="âœ…"
          DOCS_STATUS="âœ…"
          TAG_STATUS="âœ…"

          if [ "$README_VERSION" != "$POM_VERSION" ]; then README_STATUS="âŒ"; fi
          if [ "$DOCS_VERSION" != "$POM_VERSION" ] && [ "$DOCS_VERSION" != "N/A" ]; then DOCS_STATUS="âŒ"; fi
          if [ "$TAG_VERSION" != "$POM_VERSION" ] && [ "$TAG_VERSION" != "N/A" ]; then TAG_STATUS="âŒ"; fi

          if [ "$CONSISTENT" = "true" ]; then
            RESULT_STATUS="âœ… **é€šè¿‡**"
            WARNING=""
          else
            RESULT_STATUS="âŒ **å¤±è´¥**"
            WARNING="âš ï¸ è¯·ç¡®ä¿æ‰€æœ‰ç‰ˆæœ¬å·ä¿æŒä¸€è‡´ï¼"
          fi

          # Write report to GitHub Actions Summary
          echo "## ğŸ” ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ¥æº | ç‰ˆæœ¬ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| POM.xml | \`$POM_VERSION\` | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| README.md | \`$README_VERSION\` | $README_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| docs/ | \`$DOCS_VERSION\` | $DOCS_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Git Tag | \`$TAG_VERSION\` | $TAG_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç»“æœ:** $RESULT_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$WARNING" >> $GITHUB_STEP_SUMMARY

          # Set outputs
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat $GITHUB_STEP_SUMMARY >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # ==================== Job 2: è‡ªåŠ¨åŒ–æµ‹è¯• ====================
  automated-tests:
    runs-on: ubuntu-latest
    needs: version-check
    if: always()
    outputs:
      passed: ${{ steps.summary.outputs.passed }}
      total: ${{ steps.summary.outputs.total }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Compile Test Code
        id: compile
        continue-on-error: true
        run: |
          mvn test-compile 2>&1 | tee compile.log
          if grep -q "BUILD SUCCESS" compile.log; then
            echo "compile_status=success" >> $GITHUB_OUTPUT
          else
            echo "compile_status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Run Core Tests
        id: core_tests
        continue-on-error: true
        run: |
          echo "ğŸ§ª Running Core Tests..."
          mvn test -DskipTests=false \
            -Dtest=TestJNetUtils,TestPair,TestRequest,TestResponse,TestJNetClient,TestConcurrency \
            -DreportFormat=xml,html 2>&1 | tee core-test.log || true

          # æå–ç»“æœ
          grep 'Tests run:' core-test.log | sed -n 's/.*Tests run: \([0-9]*\).*/\1/p' | head -1 > core_total.txt || echo "0" > core_total.txt
          grep 'Failures:' core-test.log | sed -n 's/.*Failures: \([0-9]*\).*/\1/p' | head -1 > core_failures.txt || echo "0" > core_failures.txt
          grep 'Errors:' core-test.log | sed -n 's/.*Errors: \([0-9]*\).*/\1/p' | head -1 > core_errors.txt || echo "0" > core_errors.txt

      - name: Run Interceptor Tests
        id: interceptor_tests
        continue-on-error: true
        run: |
          echo "ğŸ§ª Running Interceptor Tests..."
          mvn test -DskipTests=false \
            -Dtest=TestInterceptorFull \
            -DreportFormat=xml,html 2>&1 | tee interceptor-test.log || true

          grep 'Tests run:' interceptor-test.log | sed -n 's/.*Tests run: \([0-9]*\).*/\1/p' | head -1 > int_total.txt || echo "0" > int_total.txt
          grep 'Failures:' interceptor-test.log | sed -n 's/.*Failures: \([0-9]*\).*/\1/p' | head -1 > int_failures.txt || echo "0" > int_failures.txt
          grep 'Errors:' interceptor-test.log | sed -n 's/.*Errors: \([0-9]*\).*/\1/p' | head -1 > int_errors.txt || echo "0" > int_errors.txt

      - name: Run SSE Tests
        id: sse_tests
        continue-on-error: true
        run: |
          echo "ğŸ§ª Running SSE Tests..."
          mvn test -DskipTests=false \
            -Dtest=SSERealTimeAPITest\\\$BasicSSETest \
            -DreportFormat=xml,html 2>&1 | tee sse-test.log || true

          grep 'Tests run:' sse-test.log | sed -n 's/.*Tests run: \([0-9]*\).*/\1/p' | head -1 > sse_total.txt || echo "0" > sse_total.txt
          grep 'Failures:' sse-test.log | sed -n 's/.*Failures: \([0-9]*\).*/\1/p' | head -1 > sse_failures.txt || echo "0" > sse_failures.txt
          grep 'Errors:' sse-test.log | sed -n 's/.*Errors: \([0-9]*\).*/\1/p' | head -1 > sse_errors.txt || echo "0" > sse_errors.txt

      - name: Generate Test Report
        id: summary
        if: always()
        run: |
          # è¯»å–ç»“æœ
          CORE_TOTAL=$(cat core_total.txt 2>/dev/null || echo "0")
          CORE_FAIL=$(cat core_failures.txt 2>/dev/null || echo "0")
          CORE_ERR=$(cat core_errors.txt 2>/dev/null || echo "0")
          CORE_PASS=$((CORE_TOTAL - CORE_FAIL - CORE_ERR))

          INT_TOTAL=$(cat int_total.txt 2>/dev/null || echo "0")
          INT_FAIL=$(cat int_failures.txt 2>/dev/null || echo "0")
          INT_ERR=$(cat int_errors.txt 2>/dev/null || echo "0")
          INT_PASS=$((INT_TOTAL - INT_FAIL - INT_ERR))

          SSE_TOTAL=$(cat sse_total.txt 2>/dev/null || echo "0")
          SSE_FAIL=$(cat sse_failures.txt 2>/dev/null || echo "0")
          SSE_ERR=$(cat sse_errors.txt 2>/dev/null || echo "0")
          SSE_PASS=$((SSE_TOTAL - SSE_FAIL - SSE_ERR))

          # è®¡ç®—æ€»æ•°
          TOTAL=$((CORE_TOTAL + INT_TOTAL + SSE_TOTAL))
          PASS=$((CORE_PASS + INT_PASS + SSE_PASS))
          FAIL=$((CORE_FAIL + INT_FAIL + SSE_FAIL))
          ERR=$((CORE_ERR + INT_ERR + SSE_ERR))

          # Determine test group status
          CORE_STATUS="âœ…"
          INT_STATUS="âœ…"
          SSE_STATUS="âœ…"

          if [ "$CORE_FAIL" -gt 0 ] || [ "$CORE_ERR" -gt 0 ]; then CORE_STATUS="âŒ"; fi
          if [ "$INT_FAIL" -gt 0 ] || [ "$INT_ERR" -gt 0 ]; then INT_STATUS="âŒ"; fi
          if [ "$SSE_FAIL" -gt 0 ] || [ "$SSE_ERR" -gt 0 ]; then SSE_STATUS="âŒ"; fi

          # ç”ŸæˆæŠ¥å‘Šå¹¶ç›´æ¥å†™å…¥ Summary
          echo "## ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æµ‹è¯•æ¦‚è§ˆ" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€»æµ‹è¯•æ•°**: $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **é€šè¿‡**: $PASS âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **å¤±è´¥**: $FAIL âŒ" >> $GITHUB_STEP_SUMMARY
          echo "- **é”™è¯¯**: $ERR âš ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### è¯¦ç»†ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æµ‹è¯•ç»„ | æ€»æ•° | é€šè¿‡ | å¤±è´¥ | é”™è¯¯ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|------|------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| æ ¸å¿ƒåŠŸèƒ½ | $CORE_TOTAL | $CORE_PASS | $CORE_FAIL | $CORE_ERR | $CORE_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| æ‹¦æˆªå™¨ | $INT_TOTAL | $INT_PASS | $INT_FAIL | $INT_ERR | $INT_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| SSE | $SSE_TOTAL | $SSE_PASS | $SSE_FAIL | $SSE_ERR | $SSE_STATUS |" >> $GITHUB_STEP_SUMMARY

          # è®¾ç½®è¾“å‡º
          echo "passed=$PASS" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

  # ==================== Job 3: è´¨é‡æ£€æµ‹ (SAST) ====================
  security-scan:
    runs-on: ubuntu-latest
    needs: [version-check, automated-tests]
    if: always()
    outputs:
      security_passed: ${{ steps.security.outputs.passed }}
      report: ${{ steps.summary.outputs.report }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run SpotBugs (é™æ€ä»£ç åˆ†æ)
        id: spotbugs
        continue-on-error: true
        run: |
          echo "ğŸ” Running SpotBugs..."
          mvn com.github.spotbugs:spotbugs-maven-plugin:5.2.3:check \
            -Dspotbugs.includeFilterFile=spotbugs-security.xml \
            -Dspotbugs.maxRank=10 \
            2>&1 | tee spotbugs.log || true

          # æå–è­¦å‘Šæ•°é‡
          WARNINGS=$(grep 'Total:' spotbugs.log | sed -n 's/.*Total: \([0-9]*\) warnings.*/\1/p' | head -1 || echo "0")
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

          if grep -q "BUILD SUCCESS" spotbugs.log; then
            echo "spotbugs_status=passed" >> $GITHUB_OUTPUT
          else
            echo "spotbugs_status=warnings" >> $GITHUB_OUTPUT
          fi

      - name: Run Dependency Check (ä¾èµ–æ¼æ´æ‰«æ)
        id: depcheck
        continue-on-error: true
        run: |
          echo "ğŸ” Running OWASP Dependency Check..."
          mvn org.owasp:dependency-check-maven:9.0.9:check \
            -DfailBuildOnCVSS=7 \
            -Dformat=HTML,JSON \
            2>&1 | tee depcheck.log || true

          # æ£€æŸ¥ç»“æœ
          if [ -f "target/dependency-check-report.html" ]; then
            echo "depcheck_status=completed" >> $GITHUB_OUTPUT

            # ç»Ÿè®¡æ¼æ´
            HIGH=$(grep '"severity":"HIGH"' target/dependency-check-report.json 2>/dev/null | wc -l || echo "0")
            MEDIUM=$(grep '"severity":"MEDIUM"' target/dependency-check-report.json 2>/dev/null | wc -l || echo "0")
            LOW=$(grep '"severity":"LOW"' target/dependency-check-report.json 2>/dev/null | wc -l || echo "0")

            echo "high_vuln=$HIGH" >> $GITHUB_OUTPUT
            echo "medium_vuln=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low_vuln=$LOW" >> $GITHUB_OUTPUT

            if [ "$HIGH" -eq 0 ] && [ "$MEDIUM" -eq 0 ]; then
              echo "depcheck_passed=true" >> $GITHUB_OUTPUT
            else
              echo "depcheck_passed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "depcheck_status=skipped" >> $GITHUB_OUTPUT
            echo "depcheck_passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Run Maven Security Check
        id: security
        continue-on-error: true
        run: |
          echo "ğŸ” Running Maven Security Check..."

          # æ£€æŸ¥å¸¸è§å®‰å…¨é—®é¢˜
          SECURITY_ISSUES=0

          # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ä¸å®‰å…¨çš„ SSL é…ç½®
          if grep -r "trustAllCertificates" src/main/java/ 2>/dev/null | grep -v "Test" | grep -v "//"; then
            echo "âš ï¸  Found trustAllCertificates usage"
            ((SECURITY_ISSUES++))
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç å¯†ç 
          if grep -r "password" src/main/java/ 2>/dev/null | grep -v "getPassword" | grep -v "//" | grep -v "javadoc"; then
            echo "âš ï¸  Possible hardcoded password found"
            ((SECURITY_ISSUES++))
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰å‘½ä»¤æ³¨å…¥é£é™©
          if grep -r "Runtime.exec\|ProcessBuilder" src/main/java/ 2>/dev/null | grep -v "Test"; then
            echo "âš ï¸  Found Runtime.exec usage"
            ((SECURITY_ISSUES++))
          fi

          if [ $SECURITY_ISSUES -eq 0 ]; then
            echo "security_passed=true" >> $GITHUB_OUTPUT
          else
            echo "security_passed=false" >> $GITHUB_OUTPUT
            echo "security_issues=$SECURITY_ISSUES" >> $GITHUB_OUTPUT
          fi

      - name: Generate Security Report
        id: summary
        if: always()
        run: |
          # æ”¶é›†æ‰€æœ‰ç»“æœ
          SPOTBUGS_STATUS="${{ steps.spotbugs.outputs.spotbugs_status }}"
          SPOTBUGS_WARNINGS="${{ steps.spotbugs.outputs.warnings }}"

          DEPCHECK_STATUS="${{ steps.depcheck.outputs.depcheck_status }}"
          DEPCHECK_PASSED="${{ steps.depcheck.outputs.depcheck_passed }}"
          HIGH_VULN="${{ steps.depcheck.outputs.high_vuln }}"
          MEDIUM_VULN="${{ steps.depcheck.outputs.medium_vuln }}"
          LOW_VULN="${{ steps.depcheck.outputs.low_vuln }}"

          SECURITY_PASSED="${{ steps.security.outputs.security_passed }}"
          SECURITY_ISSUES="${{ steps.security.outputs.security_issues }}"

          # è®¡ç®—æ•´ä½“çŠ¶æ€
          ALL_PASSED=true
          if [ "$SPOTBUGS_STATUS" != "passed" ]; then ALL_PASSED=false; fi
          if [ "$DEPCHECK_PASSED" != "true" ]; then ALL_PASSED=false; fi
          if [ "$SECURITY_PASSED" != "true" ]; then ALL_PASSED=false; fi

          # Determine security status
          if [ "$ALL_PASSED" = "true" ]; then
            OVERALL_STATUS="âœ… **é€šè¿‡**"
            OVERALL_ADVICE="âœ… æ‰€æœ‰å®‰å…¨æ£€æŸ¥é€šè¿‡ï¼"
          else
            OVERALL_STATUS="âŒ **éœ€è¦å…³æ³¨**"
            OVERALL_ADVICE="âš ï¸ è¯·æ£€æŸ¥ä¸Šè¿°é—®é¢˜å¹¶ä¿®å¤ã€‚"
          fi

          if [ "$SPOTBUGS_STATUS" = "passed" ]; then
            SPOTBUGS_STATUS_TEXT="âœ… é€šè¿‡"
          else
            SPOTBUGS_STATUS_TEXT="âš ï¸ æœ‰è­¦å‘Š"
          fi

          if [ "$DEPCHECK_STATUS" = "completed" ]; then
            DEPCHECK_STATUS_TEXT="âœ… å®Œæˆ"
            if [ "$DEPCHECK_PASSED" != "true" ]; then
              DEPCHECK_ADVICE="**æ³¨æ„**: é«˜å±/ä¸­å±æ¼æ´éœ€è¦ä¼˜å…ˆä¿®å¤ï¼"
            else
              DEPCHECK_ADVICE=""
            fi
          else
            DEPCHECK_STATUS_TEXT="âš ï¸ è·³è¿‡"
            DEPCHECK_ADVICE=""
          fi

          if [ "$HIGH_VULN" -eq 0 ]; then
            HIGH_STATUS="âœ…"
          else
            HIGH_STATUS="âŒ"
          fi

          if [ "$MEDIUM_VULN" -eq 0 ]; then
            MEDIUM_STATUS="âœ…"
          else
            MEDIUM_STATUS="âš ï¸"
          fi

          if [ "$SECURITY_PASSED" = "true" ]; then
            SECURITY_STATUS_TEXT="âœ… é€šè¿‡"
          else
            SECURITY_STATUS_TEXT="âš ï¸ å‘ç°é—®é¢˜"
          fi

          SECURITY_ISSUES_COUNT="${SECURITY_ISSUES:-0}"

          # ç”ŸæˆæŠ¥å‘Šå¹¶ç›´æ¥å†™å…¥ Summary
          echo "## ğŸ”’ è´¨é‡ä¸å®‰å…¨æ£€æµ‹æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ£€æµ‹æ¦‚è§ˆ" >> $GITHUB_STEP_SUMMARY
          echo "**æ€»ä½“çŠ¶æ€**: $OVERALL_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 1. é™æ€ä»£ç åˆ†æ (SpotBugs)" >> $GITHUB_STEP_SUMMARY
          echo "- çŠ¶æ€: $SPOTBUGS_STATUS_TEXT" >> $GITHUB_STEP_SUMMARY
          echo "- è­¦å‘Šæ•°: $SPOTBUGS_WARNINGS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 2. ä¾èµ–æ¼æ´æ‰«æ (OWASP)" >> $GITHUB_STEP_SUMMARY
          echo "- çŠ¶æ€: $DEPCHECK_STATUS_TEXT" >> $GITHUB_STEP_SUMMARY
          echo "- é«˜å±æ¼æ´: $HIGH_VULN $HIGH_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- ä¸­å±æ¼æ´: $MEDIUM_VULN $MEDIUM_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- ä½å±æ¼æ´: $LOW_VULN" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 3. ä»£ç å®‰å…¨æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "- çŠ¶æ€: $SECURITY_STATUS_TEXT" >> $GITHUB_STEP_SUMMARY
          echo "- å®‰å…¨é—®é¢˜æ•°: $SECURITY_ISSUES_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å»ºè®®" >> $GITHUB_STEP_SUMMARY
          echo "$OVERALL_ADVICE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$DEPCHECK_ADVICE" >> $GITHUB_STEP_SUMMARY

          # è®¾ç½®è¾“å‡º
          echo "passed=$ALL_PASSED" >> $GITHUB_OUTPUT
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat $GITHUB_STEP_SUMMARY >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # ==================== Job 4: æœ€ç»ˆæ±‡æ€» ====================
  summary:
    runs-on: ubuntu-latest
    needs: [version-check, automated-tests, security-scan]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Final Summary
        run: |
          # è·å–å„ Job çŠ¶æ€
          VERSION_CONSISTENT="${{ needs.version-check.outputs.consistent }}"
          TESTS_PASSED="${{ needs.automated-tests.outputs.passed }}"
          TESTS_TOTAL="${{ needs.automated-tests.outputs.total }}"
          SECURITY_PASSED="${{ needs.security-scan.outputs.security_passed }}"

          # è®¡ç®—æ•´ä½“çŠ¶æ€
          ALL_PASSED=true
          FAILURES=()

          if [ "$VERSION_CONSISTENT" != "true" ]; then
            ALL_PASSED=false
            FAILURES+=("ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥")
          fi

          if [ "$TESTS_PASSED" != "$TESTS_TOTAL" ] && [ "$TESTS_TOTAL" != "0" ]; then
            ALL_PASSED=false
            FAILURES+=("è‡ªåŠ¨åŒ–æµ‹è¯•")
          fi

          if [ "$SECURITY_PASSED" != "true" ]; then
            ALL_PASSED=false
            FAILURES+=("è´¨é‡ä¸å®‰å…¨æ£€æµ‹")
          fi

          # Determine final status
          if [ "$ALL_PASSED" = "true" ]; then
            FINAL_STATUS="## âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"
            NEEDS_FIX=""
          else
            FINAL_STATUS="## âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥"
            NEEDS_FIX="## âš ï¸ éœ€è¦ä¿®å¤çš„é—®é¢˜"
          fi

          # Determine version check status
          if [ "$VERSION_CONSISTENT" = "true" ]; then
            VERSION_STATUS="âœ… é€šè¿‡"
          else
            VERSION_STATUS="âŒ å¤±è´¥"
          fi

          # Determine security status
          if [ "$SECURITY_PASSED" = "true" ]; then
            SECURITY_STATUS="âœ… é€šè¿‡"
          else
            SECURITY_STATUS="âŒ éœ€è¦å…³æ³¨"
          fi

          # ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
          echo "# ğŸ“Š CI æœ€ç»ˆæŠ¥å‘Š" > /tmp/final_summary.md
          echo "" >> /tmp/final_summary.md
          echo "## ğŸ¯ æ•´ä½“çŠ¶æ€" >> /tmp/final_summary.md
          echo "$FINAL_STATUS" >> /tmp/final_summary.md
          echo "" >> /tmp/final_summary.md
          echo "## ğŸ“‹ æ£€æŸ¥è¯¦æƒ…" >> /tmp/final_summary.md
          echo "" >> /tmp/final_summary.md
          echo "### 1. ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥" >> /tmp/final_summary.md
          echo "- çŠ¶æ€: $VERSION_STATUS" >> /tmp/final_summary.md
          echo "- å½±å“: ç¡®ä¿ POMã€READMEã€Docsã€Tag ç‰ˆæœ¬ä¸€è‡´" >> /tmp/final_summary.md
          echo "" >> /tmp/final_summary.md
          echo "### 2. è‡ªåŠ¨åŒ–æµ‹è¯•" >> /tmp/final_summary.md
          echo "- çŠ¶æ€: $TESTS_PASSED/$TESTS_TOTAL é€šè¿‡" >> /tmp/final_summary.md
          echo "- å½±å“: ç¡®ä¿åŠŸèƒ½æ­£å¸¸" >> /tmp/final_summary.md
          echo "" >> /tmp/final_summary.md
          echo "### 3. è´¨é‡ä¸å®‰å…¨æ£€æµ‹" >> /tmp/final_summary.md
          echo "- çŠ¶æ€: $SECURITY_STATUS" >> /tmp/final_summary.md
          echo "- å½±å“: ç¡®ä¿ä»£ç è´¨é‡å’Œå®‰å…¨" >> /tmp/final_summary.md
          echo "" >> /tmp/final_summary.md
          echo "$NEEDS_FIX" >> /tmp/final_summary.md

          # æ·»åŠ å¤±è´¥åˆ—è¡¨
          if [ "$ALL_PASSED" != "true" ]; then
            for failure in "${FAILURES[@]}"; do
              echo "- $failure" >> /tmp/final_summary.md
            done
          fi

          # æ·»åŠ ä¸‹è½½é“¾æ¥
          echo "" >> /tmp/final_summary.md
          echo "## ğŸ“¥ è¯¦ç»†æ£€æŸ¥ç»“æœ" >> /tmp/final_summary.md
          echo "" >> /tmp/final_summary.md
          echo "æ‰€æœ‰è¯¦ç»†æŠ¥å‘Šå·²ç›´æ¥å±•ç¤ºåœ¨ä¸Šæ–¹ï¼Œæ— éœ€ä¸‹è½½ã€‚" >> /tmp/final_summary.md
          echo "" >> /tmp/final_summary.md
          echo "---" >> /tmp/final_summary.md
          echo "*ç”Ÿæˆæ—¶é—´: $(date -u "%Y-%m-%d %H:%M:%S UTC")*" >> /tmp/final_summary.md

          # è¾“å‡ºåˆ° Summary
          cat /tmp/final_summary.md >> $GITHUB_STEP_SUMMARY

          # å¦‚æœå¤±è´¥ï¼Œä¹Ÿè¾“å‡ºåˆ°æ§åˆ¶å°
          if [ "$ALL_PASSED" != "true" ]; then
            echo "âŒ CI æ£€æŸ¥å¤±è´¥ï¼Œéœ€è¦ä¿®å¤ä»¥ä¸‹é—®é¢˜:"
            for failure in "${FAILURES[@]}"; do
              echo "  - $failure"
            done
            exit 1
          else
            echo "âœ… CI æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"
          fi

