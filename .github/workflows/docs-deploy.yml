name: ğŸ“„ Deploy Documentation

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force:
        description: 'Force deployment even if no changes detected'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

  # æ¨é€åˆ° main åˆ†æ”¯æ—¶ï¼Œdocs ç›®å½•æœ‰å˜åŒ–
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'README.md'
      - 'update.md'

  # Pull Request å…³é—­å¹¶åˆå¹¶æ—¶
  pull_request:
    types: [closed]
    branches:
      - main
    paths:
      - 'docs/**'

# è®¾ç½®æƒé™
permissions:
  contents: write
  pages: write
  id-token: write

# å–æ¶ˆå¹¶å‘è¿è¡Œ
concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  # éƒ¨ç½²ä½œä¸š
  deploy:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.event.commits[0].message != 'skip ci') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check Documentation Changes
        id: changes
        run: |
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            echo "force_deploy=true" >> $GITHUB_OUTPUT
            echo "ğŸš€ Forced deployment requested"
            exit 0
          fi

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PR, check if docs were modified
            if git diff --name-only origin/main...HEAD | grep -q "^docs/"; then
              echo "docs_changed=true" >> $GITHUB_OUTPUT
              echo "ğŸ“ Documentation changes detected in PR"
            else
              echo "docs_changed=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ No documentation changes in PR"
            fi
          else
            # For push, check last commit
            if git diff --name-only HEAD~1 HEAD | grep -q "^docs/"; then
              echo "docs_changed=true" >> $GITHUB_OUTPUT
              echo "ğŸ“ Documentation changes detected"
            else
              echo "docs_changed=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ No documentation changes"
            fi
          fi

      - name: ğŸš« Skip if No Changes
        if: steps.changes.outputs.docs_changed == 'false' && github.event.inputs.force != 'true'
        run: |
          echo "â­ï¸ No documentation changes detected. Skipping deployment."
          exit 0

      - name: ğŸ“Š Update GitHub Stats
        run: |
          echo "ğŸ”„ Updating GitHub repository statistics..."

          # è·å–ä»“åº“ç»Ÿè®¡ä¿¡æ¯
          STATS=$(curl -s "https://api.github.com/repos/${{ github.repository }}")
          if [ $? -eq 0 ]; then
            STARS=$(echo "$STATS" | jq -r '.stargazers_count')
            FORKS=$(echo "$STATS" | jq -r '.forks_count')
            ISSUES=$(echo "$STATS" | jq -r '.open_issues_count')
            WATCHERS=$(echo "$STATS" | jq -r '.subscribers_count')

            echo "ğŸ“Š Stats: Stars=$STARS, Forks=$FORKS, Issues=$ISSUES, Watchers=$WATCHERS"

            # åˆ›å»º stats.json
            cat > docs/stats.json << EOF
            {
              "stars": $STARS,
              "forks": $FORKS,
              "issues": $ISSUES,
              "watchers": $WATCHERS,
              "lastUpdated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }
            EOF

            echo "âœ… Stats updated"
          else
            echo "âš ï¸ Failed to fetch GitHub stats, using defaults"
            cat > docs/stats.json << EOF
            {
              "stars": 0,
              "forks": 0,
              "issues": 0,
              "watchers": 0,
              "lastUpdated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "note": "Stats fetch failed"
            }
            EOF
          fi

      - name: ğŸ“ Update Deployment Metadata
        run: |
          # åˆ›å»ºéƒ¨ç½²å…ƒæ•°æ®
          cat > docs/deployment.json << EOF
          {
            "deployedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "version": "${{ github.sha }}",
            "actor": "${{ github.actor }}",
            "event": "${{ github.event_name }}",
            "ref": "${{ github.ref }}",
            "repository": "${{ github.repository }}"
          }
          EOF

          # æ›´æ–°æœ€åéƒ¨ç½²æ—¶é—´
          echo "$(date -u)" > docs/.last-deploy

          echo "âœ… Metadata updated"

      - name: ğŸ§ª Validate Documentation
        run: |
          echo "ğŸ” Validating documentation files..."

          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          REQUIRED_FILES=("index.html" "showcase.html" "discuss.html" "profile.html" "i18n.js")
          MISSING_FILES=()

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "docs/$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done

          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "âŒ Missing required files: ${MISSING_FILES[*]}"
            exit 1
          fi

          echo "âœ… All required files present"

          # ç®€å•çš„ HTML éªŒè¯
          for html_file in docs/*.html; do
            if grep -q "<!DOCTYPE html>" "$html_file" && grep -q "</html>" "$html_file"; then
              echo "âœ… $(basename $html_file) structure valid"
            else
              echo "âš ï¸ $(basename $html_file) may have issues"
            fi
          done

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          destination_dir: .
          keep_files: false
          force_orphan: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: |
            ğŸ“š Update GitHub Pages

            Event: ${{ github.event_name }}
            Actor: ${{ github.actor }}
            Ref: ${{ github.ref }}

            ğŸ¤– Auto-deployed by GitHub Actions

      - name: ğŸ“‹ Deployment Summary
        run: |
          echo "## ğŸš€ Documentation Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ Access" >> $GITHUB_STEP_SUMMARY
          echo "- **Live Site:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Files Updated" >> $GITHUB_STEP_SUMMARY
          git diff --name-only HEAD~1 HEAD 2>/dev/null | grep "^docs/" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "No file list available" >> $GITHUB_STEP_SUMMARY

  # éƒ¨ç½²åéªŒè¯
  post-deploy-check:
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.deploy.result == 'success'

    steps:
      - name: ğŸ” Verify Deployment
        run: |
          echo "â³ Waiting for GitHub Pages to update..."
          sleep 10

          URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          echo "ğŸ” Testing: $URL"

          # æµ‹è¯•ä¸»é¡µæ˜¯å¦å¯è®¿é—®
          if curl -s -I "$URL" | grep -q "200\|301\|302"; then
            echo "âœ… Main page is accessible"
          else
            echo "âš ï¸ Could not verify page accessibility (this is normal immediately after deployment)"
          fi

          echo "âœ… Deployment verification complete"

  # é€šçŸ¥ï¼ˆå¯é€‰ï¼Œéœ€è¦é…ç½® webhookï¼‰
  notify:
    runs-on: ubuntu-latest
    needs: [deploy, post-deploy-check]
    if: always() && (needs.deploy.result == 'success' || needs.deploy.result == 'skipped')

    steps:
      - name: ğŸ“¨ Create Notification
        run: |
          STATUS="${{ needs.deploy.result }}"
          echo "## ğŸ“š GitHub Pages Deployment" > /tmp/notification.md
          echo "" >> /tmp/notification.md
          echo "**Status:** $STATUS" >> /tmp/notification.md
          echo "**Repository:** ${{ github.repository }}" >> /tmp/notification.md
          echo "**Event:** ${{ github.event_name }}" >> /tmp/notification.md
          echo "**Actor:** ${{ github.actor }}" >> /tmp/notification.md
          echo "" >> /tmp/notification.md

          if [ "$STATUS" == "success" ]; then
            echo "âœ… Documentation successfully deployed!" >> /tmp/notification.md
            echo "" >> /tmp/notification.md
            echo "ğŸ”— **View Site:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> /tmp/notification.md
            echo "ğŸ”— **View Commit:** https://github.com/${{ github.repository }}/commit/${{ github.sha }}" >> /tmp/notification.md
          else
            echo "âŒ Deployment failed or was skipped" >> /tmp/notification.md
          fi

          cat /tmp/notification.md